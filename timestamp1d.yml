# Set time-stamp variables 
--- 
- name: Create date and timestamp 
  hosts: localhost
  gather_facts: false 

  pre_tasks: 
# Code for start and end time  

   - name: Get start and stop time 
     set_fact: 
       stop_time: "2022-05-11 22:21:33" 
       start_time: "2022-05-09 08:08:08"  
       zero_time: "1970-01-01 00:00:00" 

   - name: Get start and stop time variables 

     set_fact: 

       start_time_days: "{{ ((start_time | to_datetime) - (zero_time | to_datetime('%Y-%m-%d %H:%M:%S'))).days }}" 
       stop_time_days: "{{ ((stop_time | to_datetime) - (zero_time | to_datetime('%Y-%m-%d %H:%M:%S'))).days }}" 

   - name: Iteration list 
     debug: msg="Iteration {{ item }}" 
     with_sequence: start={{ ( start_time_days ) }} end={{ stop_time_days }} stride=1 

   - name: Timestamp - start time and date 
     debug: 
       msg: "start_time_days={{ ( start_time_days ) }} stop_time_days={{ stop_time_days }} divljak={{ '%Y-%m-%d 00:00:00' | strftime(0) }}" 

#Get variables for start_sec and Stop_sec to get time slot
   
   - name: Get start and stop time 
     set_fact: 
       slot_start_sec: "2022-05-10 19:00:00"
       slot_stop_sec: "2022-05-11 10:00:00"   
       time_offset: -7200


   - name: Get start_sec and stop_sec time variables 
     set_fact: 
       start_sec: "{{ (((slot_start_sec | to_datetime) - (zero_time | to_datetime('%Y-%m-%d %H:%M:%S'))).total_seconds() + time_offset ) |int }}" 
       stop_sec: "{{ (((slot_stop_sec | to_datetime) - (zero_time | to_datetime('%Y-%m-%d %H:%M:%S'))).total_seconds() + time_offset ) |int }}" 

   - debug: msg="slot_start_sec={{ ( start_sec ) }} slot_stop_sec={{ stop_sec }}" 


# Define time stamps for stop and start time in sec since the Epoch - inserted part
   - name: Iteration list 
     debug: msg="Iteration {{ item }}" 
     with_sequence: start={{ ( start_sec ) }} end={{ stop_sec }} stride=600

   - set_fact: 
       var1: "{{ var1 | default([])+[ (item ) ] }}" 
     with_sequence: start={{ ( start_sec ) }} end={{ stop_sec }} stride=600 
   
#   - debug: msg="var1={{ ( var1 ) }}" 

   - name: Temp file without header and time in sec
     shell: cat  ~/tc_simul/reports/STAT_CPU.csv | awk -F ";" -v start={{ start_sec }} -v stop={{ stop_sec }} ' NR >1 { split($3,a,/(-| |:)/); ts=mktime(sprintf("%04d %02d %02d %02d %02d %02d",a[1],a[2],a[3],a[4],a[5],a[6])) ; if( start < ts && ts < stop ){ print $0; } }' > ~/tc_simul/reports/STAT_SLOT_CPU.csv
     register: mk_sec

   - debug: msg="mk_sec={{ mk_sec.stdout }}"

